name: 20q-kakao-bot

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ==========================================
  # Storage & Infrastructure
  # ==========================================
  postgres:
    image: postgres:18-alpine
    container_name: llm-postgres
    restart: always
    labels:
      deunhealth.restart.on.unhealthy: "true"
    environment:
      POSTGRES_DB: ${DB_NAME:-twentyq}
      POSTGRES_USER: ${DB_USER:-twentyq_app}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?set DB_PASSWORD in .env}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - pg-data-v18:/var/lib/postgresql/data
      - pg-socket:/var/run/postgresql
      - ./backups:/backups
      - ./hololive-kakao-bot-go/scripts/init-db:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512m
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  valkey-cache:
    image: valkey/valkey:9.0.1-alpine3.23
    container_name: valkey-cache
    labels:
      deunhealth.restart.on.unhealthy: "true"
    ports:
      - "6379:6379"
    volumes:
      - valkey-cache-data:/data
      - valkey-cache-socket:/var/run/valkey
    command: >
      valkey-server --unixsocket /var/run/valkey/valkey-cache.sock --unixsocketperm 777 --port 6379 --appendonly no --save "" --maxmemory 384mb --maxmemory-policy allkeys-lfu --loglevel notice --io-threads 4 --io-threads-do-reads yes --activedefrag yes --active-defrag-threshold-lower 10 --active-defrag-cycle-min 1 --active-defrag-cycle-max 25
    sysctls:
      - net.core.somaxconn=1024
    restart: always
    healthcheck:
      test: [ "CMD", "valkey-cli", "-s", "/var/run/valkey/valkey-cache.sock", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512m
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  valkey-mq:
    image: valkey/valkey:9.0.1-alpine3.23
    container_name: valkey-mq
    labels:
      deunhealth.restart.on.unhealthy: "true"
    ports:
      - "1833:1833"
    volumes:
      - valkey-mq-data:/data
      - ./logs:/var/log/valkey-mq
    command: >
      valkey-server  --port 1833  --appendonly no  --save ""  --maxmemory 192mb  --maxmemory-policy noeviction  --loglevel notice --io-threads 4 --io-threads-do-reads yes --activedefrag yes --active-defrag-threshold-lower 10 --active-defrag-cycle-min 1 --active-defrag-cycle-max 25
    sysctls:
      - net.core.somaxconn=1024
    restart: always
    healthcheck:
      test: [ "CMD", "valkey-cli", "-p", "1833", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256m
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  # ==========================================
  #  Core Services (LLM Server)
  # ==========================================
  mcp-llm-server:
    build:
      context: ./mcp-llm-server-go
      dockerfile: Dockerfile.prod
    container_name: mcp-llm-server
    restart: always
    labels:
      deunhealth.restart.on.unhealthy: "true"
    env_file:
      - ./.env
    environment:
      HTTP_HOST: 0.0.0.0
      HTTP_PORT: 40527
      HTTP2_ENABLED: "true"
      GRPC_HOST: 0.0.0.0
      GRPC_PORT: 40528
      GRPC_ENABLED: "true"
      HTTP_API_KEY_REQUIRED: "true"
      RULEPACKS_DIR: /app/rulepacks
      LOG_DIR: /app/logs
      SESSION_STORE_URL: redis://valkey-cache:6379
      DB_HOST: postgres
      DB_PORT: 5432
      DB_SOCKET_PATH: /var/run/postgresql
      GUARD_THRESHOLD: 0.6
      GRPC_SOCKET_PATH: /var/run/grpc/llm.sock
    volumes:
      - ./logs:/app/logs
      - grpc-socket:/var/run/grpc
      - pg-socket:/var/run/postgresql:ro
    depends_on:
      postgres:
        condition: service_healthy
      valkey-cache:
        condition: service_healthy
    ports:
      - "40527:40527"
      - "40528:40528"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "-T", "5", "http://localhost:40527/health/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  # ==========================================
  # Bot Applications (Go)
  # ==========================================
  twentyq-bot:
    image: game-bot-go:prod
    build:
      context: ./game-bot-go
      dockerfile: Dockerfile.prod
    container_name: twentyq-bot
    restart: always
    labels:
      deunhealth.restart.on.unhealthy: "true"
    env_file:
      - ./.env
    environment:
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 30081
      LLM_BASE_URL: unix:///var/run/grpc/llm.sock
      CACHE_SOCKET_PATH: /var/run/valkey/valkey-cache.sock
      CACHE_HOST: valkey-cache
      CACHE_PORT: 6379
      MQ_HOST: valkey-mq
      MQ_PORT: 1833
      DB_HOST: postgres
      DB_PORT: 5432
      DB_SOCKET_PATH: /var/run/postgresql
      LOG_DIR: /app/logs
      GOMEMLIMIT: "450MiB"
    deploy:
      resources:
        limits:
          memory: 512m
    volumes:
      - ./logs:/app/logs
      - grpc-socket:/var/run/grpc:ro
      - valkey-cache-socket:/var/run/valkey:ro
      - pg-socket:/var/run/postgresql:ro
    ports:
      - "30081:30081"
    depends_on:
      postgres:
        condition: service_healthy
      valkey-cache:
        condition: service_healthy
      valkey-mq:
        condition: service_healthy
      mcp-llm-server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "for i in 1 2 3 4 5 6; do wget -q --spider -T 2 http://127.0.0.1:30081/health && exit 0; [ $$i -lt 6 ] && sleep 5; done; exit 1" ]
      interval: 30s
      timeout: 45s
      retries: 1
      start_period: 10s
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  turtle-soup-bot:
    image: game-bot-go:prod
    build:
      context: ./game-bot-go
      dockerfile: Dockerfile.prod
    container_name: turtle-soup-bot
    restart: always
    labels:
      deunhealth.restart.on.unhealthy: "true"
    env_file:
      - ./.env
    environment:
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 30082
      LLM_BASE_URL: unix:///var/run/grpc/llm.sock
      CACHE_SOCKET_PATH: /var/run/valkey/valkey-cache.sock
      CACHE_HOST: valkey-cache
      CACHE_PORT: 6379
      MQ_HOST: valkey-mq
      MQ_PORT: 1833
      LOG_DIR: /app/logs
      GOMEMLIMIT: "450MiB"
    deploy:
      resources:
        limits:
          memory: 512m
    command: [ "./bin/turtlesoup" ]
    volumes:
      - ./logs:/app/logs
      - grpc-socket:/var/run/grpc:ro
      - valkey-cache-socket:/var/run/valkey:ro
    ports:
      - "30082:30082"
    depends_on:
      valkey-cache:
        condition: service_healthy
      valkey-mq:
        condition: service_healthy
      mcp-llm-server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "for i in 1 2 3 4 5 6; do wget -q --spider -T 2 http://127.0.0.1:30082/health && exit 0; [ $$i -lt 6 ] && sleep 5; done; exit 1" ]
      interval: 30s
      timeout: 45s
      retries: 1
      start_period: 10s
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  hololive-bot:
    build:
      context: ./hololive-kakao-bot-go
      dockerfile: Dockerfile
    container_name: hololive-kakao-bot-go
    restart: always
    labels:
      deunhealth.restart.on.unhealthy: "true"
    env_file:
      - ./hololive-kakao-bot-go/.env
    environment:
      GOGC: "60"
      MQ_HOST: valkey-mq
      MQ_PORT: 1833
      CACHE_SOCKET_PATH: /var/run/valkey/valkey-cache.sock
      CACHE_HOST: valkey-cache
      CACHE_PORT: 6379
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_SOCKET_PATH: /var/run/postgresql
      POSTGRES_DB: hololive
      POSTGRES_USER: ${DB_USER:-twentyq_app}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      SERVER_PORT: 30001
      LOG_FILE: logs/hololive-bot.log
      GOMEMLIMIT: "450MiB"
      # 통합 Goroutine 모니터링용 외부 서비스 Health URL
      SERVICES_LLM_SERVER_HEALTH_URL: http://mcp-llm-server:40527/health
      SERVICES_GAME_BOT_TWENTYQ_HEALTH_URL: http://twentyq-bot:30081/health
      SERVICES_GAME_BOT_TURTLE_HEALTH_URL: http://turtle-soup-bot:30082/health
    volumes:
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - valkey-cache-socket:/var/run/valkey:ro
      - pg-socket:/var/run/postgresql:ro
    ports:
      - "30001:30001"
    depends_on:
      postgres:
        condition: service_healthy
      valkey-cache:
        condition: service_healthy
      valkey-mq:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        limits:
          memory: 512m
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider -T 5 http://localhost:30001/health || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 3
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    networks:
      - llm-bot-net

  # ==========================================
  # Container Health Monitor (DeUnhealth)
  # ==========================================
  deunhealth:
    image: qmcgaw/deunhealth:latest
    container_name: deunhealth
    restart: always
    network_mode: none
    environment:
      TZ: Asia/Seoul
      LOG_LEVEL: info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      resources:
        limits:
          memory: 32m
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

volumes:
  pg-data-v18:
  valkey-cache-data:
  valkey-mq-data:
  grpc-socket:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1m,mode=0777,uid=1000
  valkey-cache-socket:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1m,mode=0777
  pg-socket:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1m,mode=0777

networks:
  llm-bot-net:
    driver: bridge
