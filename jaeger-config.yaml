# Jaeger v2 Configuration with SPM (Service Performance Monitoring)
# 참조: https://www.jaegertracing.io/docs/2.13/architecture/spm/

service:
  extensions: [jaeger_storage, jaeger_query, healthcheckv2]
  pipelines:
    # 트레이스 파이프라인: OTLP → Batch → [Storage + SpanMetrics]
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [jaeger_storage_exporter, spanmetrics]
    # SPM 메트릭 파이프라인: SpanMetrics connector → Prometheus exporter
    metrics/spanmetrics:
      receivers: [spanmetrics]
      exporters: [prometheus]
  telemetry:
    resource:
      service.name: jaeger
    metrics:
      level: detailed
      readers:
        - pull:
            exporter:
              prometheus:
                host: 0.0.0.0
                port: 8888  # Jaeger 내부 메트릭 (Prometheus scrape용)
    logs:
      level: DEBUG

extensions:
  # Healthcheck v2 - 상태 확인용
  healthcheckv2:
    use_v2: true
    http:
      endpoint: 0.0.0.0:13133

  # Jaeger Query - UI 및 API 서버
  jaeger_query:
    storage:
      traces: badger_store
      metrics: prometheus_store  # SPM: Prometheus 메트릭 스토어 참조
    ui:
      config_file: /etc/jaeger/ui-config.json
    grpc:
      endpoint: 0.0.0.0:16685
    http:
      endpoint: 0.0.0.0:16686

  # Jaeger Storage - Badger 백엔드 + Prometheus 메트릭 백엔드
  jaeger_storage:
    backends:
      badger_store:
        badger:
          directories:
            keys: /badger/key
            values: /badger/data
          ephemeral: false
          ttl:
            spans: 168h  # 7일 보관
    metric_backends:
      prometheus_store:
        prometheus:
          endpoint: http://prometheus:9090
          # SPM 메트릭 정규화 옵션
          normalize_calls: true      # calls_total → calls
          normalize_duration: true   # duration_milliseconds → duration
          latency_unit: ms           # 레이턴시 단위 (ms)

# SpanMetrics Connector - 트레이스에서 RED 메트릭 생성
connectors:
  spanmetrics:
    # Jaeger SPM이 기대하는 기본 메트릭 prefix: traces_span_metrics_*
    namespace: traces_span_metrics
    histogram:
      explicit:
        buckets: [2ms, 4ms, 6ms, 8ms, 10ms, 50ms, 100ms, 200ms, 400ms, 800ms, 1s, 1400ms, 2s, 5s, 10s, 15s]
    exemplars:
      enabled: true

receivers:
  # OTLP 수신기 - gRPC 및 HTTP 프로토콜
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # 배치 처리기 - 성능 최적화
  batch:
    timeout: 1s
    send_batch_size: 1024

exporters:
  # Jaeger Storage로 트레이스 내보내기
  jaeger_storage_exporter:
    trace_storage: badger_store
  # Prometheus exporter - SPM 메트릭 노출 (Prometheus가 scrape)
  prometheus:
    endpoint: 0.0.0.0:8889
