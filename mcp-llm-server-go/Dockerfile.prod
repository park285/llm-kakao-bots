# syntax=docker/dockerfile:1.7

ARG GO_VERSION=1.25.5
ARG ALPINE_VERSION=3.23

FROM golang:${GO_VERSION}-alpine${ALPINE_VERSION} AS builder

# 빌드 시 버전 주입 (docker-compose args 또는 --build-arg로 전달)
ARG VERSION=dev

WORKDIR /app

COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod --mount=type=cache,target=/root/.cache/go-build go mod download

COPY . .

RUN --mount=type=cache,target=/go/pkg/mod --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 GOEXPERIMENT=greenteagc \
    go build -tags go_json -trimpath -buildvcs=false -ldflags="-s -w -buildid= -X main.Version=${VERSION}" -o /app/bin/server ./cmd/server

FROM alpine:${ALPINE_VERSION}

RUN apk add --no-cache ca-certificates tini tzdata && \
    cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime && \
    echo "Asia/Seoul" > /etc/timezone && \
    cp /usr/share/zoneinfo/Asia/Seoul /tmp/Seoul && \
    apk del --no-cache tzdata && \
    mkdir -p /usr/share/zoneinfo/Asia && \
    mv /tmp/Seoul /usr/share/zoneinfo/Asia/Seoul

RUN addgroup -g 1000 appuser \
    && adduser -D -u 1000 -G appuser appuser

WORKDIR /app

COPY --from=builder --link --chown=appuser:appuser /app/bin/server ./bin/server
COPY --from=builder --link --chown=appuser:appuser /app/rulepacks ./rulepacks

RUN mkdir -p /app/logs && chown -R appuser:appuser /app

EXPOSE 40527 40528

# GC 최적화
ENV GOGC=200 \
    GOMEMLIMIT=900MiB \
    HTTP_HOST=0.0.0.0 \
    HTTP_PORT=40527 \
    HTTP2_ENABLED=true \
    GRPC_HOST=0.0.0.0 \
    GRPC_PORT=40528 \
    GRPC_ENABLED=true \
    RULEPACKS_DIR=/app/rulepacks \
    LOG_DIR=/app/logs

# 헬스체크 (30초 간격, 시작 대기 10초)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD wget -q --spider http://localhost:40527/health/ready || exit 1

USER appuser

ENTRYPOINT ["/sbin/tini", "--"]
CMD ["./bin/server"]
