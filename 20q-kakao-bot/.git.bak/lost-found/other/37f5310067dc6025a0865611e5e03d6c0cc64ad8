#!/usr/bin/env python3
import os
import sys
import requests
import json

# Load API keys from environment
keys_str = os.getenv('GOOGLE_API_KEYS', '')
keys = [k.strip() for k in keys_str.split(',') if k.strip()]

if not keys:
    print("No API keys found in GOOGLE_API_KEYS")
    sys.exit(1)

print(f"Testing {len(keys)} API keys for gemini-2.5-pro cache creation...\n")

# Create a large enough system prompt (>2048 tokens)
system_prompt = """
You are an AI game master for a 20 Questions style game. Your role is to answer player questions with YES, NO, or CANNOT_ANSWER responses. You must be precise, logical, and consistent.

""" + """
Topic Database (Extended):
""" + "\n".join([f"- Topic {i}: 항목 {i}" for i in range(1, 500)])

request_body = {
    "model": "models/gemini-2.5-pro",
    "systemInstruction": {
        "parts": [{"text": system_prompt}]
    },
    "ttl": "300s"
}

results = []

for idx, key in enumerate(keys, 1):
    key_prefix = key[:20]
    print(f"=== Testing Key {idx}: {key_prefix}... ===")

    request_body["displayName"] = f"test-cache-key{idx}-python"

    try:
        response = requests.post(
            f"https://generativelanguage.googleapis.com/v1beta/cachedContents?key={key}",
            headers={"Content-Type": "application/json"},
            json=request_body,
            timeout=30
        )

        status_code = response.status_code
        response_json = response.json()

        if status_code == 200:
            print(f"✅ SUCCESS - Cache created")
            print(f"   Cache ID: {response_json.get('name', 'N/A')}")
            results.append({"key": idx, "status": "SUCCESS", "code": 200})
        elif status_code == 429:
            error_msg = response_json.get('error', {}).get('message', 'Unknown')
            print(f"❌ 429 TOO MANY REQUESTS")
            print(f"   Message: {error_msg}")
            results.append({"key": idx, "status": "429_ERROR", "code": 429, "message": error_msg})
        else:
            error_msg = response_json.get('error', {}).get('message', 'Unknown')
            print(f"⚠️  HTTP {status_code}")
            print(f"   Message: {error_msg}")
            results.append({"key": idx, "status": "OTHER_ERROR", "code": status_code, "message": error_msg})

    except Exception as e:
        print(f"❌ EXCEPTION: {str(e)}")
        results.append({"key": idx, "status": "EXCEPTION", "error": str(e)})

    print()

# Summary
print("="*50)
print("SUMMARY:")
print("="*50)
for r in results:
    status_emoji = "✅" if r["status"] == "SUCCESS" else "❌"
    print(f"{status_emoji} Key {r['key']}: {r['status']} (HTTP {r.get('code', 'N/A')})")
    if "message" in r:
        print(f"   → {r['message'][:100]}")

# Check if both keys have 429
keys_with_429 = [r for r in results if r.get('code') == 429]
if len(keys_with_429) == len(keys):
    print("\n⚠️  ALL keys returned 429 - Free tier cache limit issue!")
elif len(keys_with_429) > 0:
    print(f"\n⚠️  {len(keys_with_429)}/{len(keys)} keys returned 429")
else:
    print("\n✅ No 429 errors detected")
