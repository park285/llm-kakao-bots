package party.qwer.twentyq.service

import io.mockk.coEvery
import io.mockk.coVerify
import io.mockk.mockk
import kotlinx.coroutines.runBlocking
import org.assertj.core.api.Assertions.assertThat
import org.assertj.core.api.Assertions.assertThatThrownBy
import org.assertj.core.data.Offset
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test

@DisplayName("VectorSimilarityService")
class VectorSimilarityServiceTest {
    private lateinit var geminiApiClient: GeminiApiClient
    private lateinit var service: VectorSimilarityService

    @BeforeEach
    fun setUp() {
        geminiApiClient = mockk(relaxed = true)
        service = VectorSimilarityService(geminiApiClient)
    }

    @Nested
    @DisplayName("cosineSimilarity")
    inner class CosineSimilarityTest {
        @Test
        fun `빈 문자열 - 0점0 반환`() =
            runBlocking {
                val result1 = service.cosineSimilarity("", "텍스트")
                val result2 = service.cosineSimilarity("텍스트", "")
                val result3 = service.cosineSimilarity("", "")

                assertThat(result1).isCloseTo(0.0, Offset.offset(0.0001))
                assertThat(result2).isCloseTo(0.0, Offset.offset(0.0001))
                assertThat(result3).isCloseTo(0.0, Offset.offset(0.0001))

                // API 호출 안됨
                coVerify(exactly = 0) { geminiApiClient.embedText(any(), any()) }
            }

        @Test
        fun `공백 문자열 - 0점0 반환`() =
            runBlocking {
                val result = service.cosineSimilarity("   ", "텍스트")

                assertThat(result).isCloseTo(0.0, Offset.offset(0.0001))
                coVerify(exactly = 0) { geminiApiClient.embedText(any(), any()) }
            }

        @Test
        fun `동일한 문자열 - 1점0 반환`() =
            runBlocking {
                val result = service.cosineSimilarity("사과", "사과")

                assertThat(result).isCloseTo(1.0, Offset.offset(0.0001))

                // 동일하면 API 호출 안됨
                coVerify(exactly = 0) { geminiApiClient.embedText(any(), any()) }
            }

        @Test
        fun `정상 케이스 - 벡터 유사도 계산`() =
            runBlocking {
                val vec1 = FloatArray(1536) { 1.0f }
                val vec2 = FloatArray(1536) { 1.0f }

                coEvery { geminiApiClient.embedText("사과", 1536) } returns vec1
                coEvery { geminiApiClient.embedText("과일", 1536) } returns vec2

                val result = service.cosineSimilarity("사과", "과일")

                // 같은 벡터이므로 1.0
                assertThat(result).isCloseTo(1.0, Offset.offset(0.0001))

                coVerify(exactly = 1) { geminiApiClient.embedText("사과", 1536) }
                coVerify(exactly = 1) { geminiApiClient.embedText("과일", 1536) }
            }

        @Test
        fun `유사도 계산 - 직교 벡터`() =
            runBlocking {
                val vec1 = floatArrayOf(1.0f, 0.0f, 0.0f) + FloatArray(1533) { 0.0f }
                val vec2 = floatArrayOf(0.0f, 1.0f, 0.0f) + FloatArray(1533) { 0.0f }

                coEvery { geminiApiClient.embedText("A", 1536) } returns vec1
                coEvery { geminiApiClient.embedText("B", 1536) } returns vec2

                val result = service.cosineSimilarity("A", "B")

                // 직교 벡터는 유사도 0.0
                assertThat(result).isCloseTo(0.0, Offset.offset(0.0001))
            }

        @Test
        fun `유사도 계산 - 반대 방향 벡터`() =
            runBlocking {
                val vec1 = FloatArray(1536) { 1.0f }
                val vec2 = FloatArray(1536) { -1.0f }

                coEvery { geminiApiClient.embedText("긍정", 1536) } returns vec1
                coEvery { geminiApiClient.embedText("부정", 1536) } returns vec2

                val result = service.cosineSimilarity("긍정", "부정")

                // 반대 방향 벡터는 유사도 -1.0
                assertThat(result).isCloseTo(-1.0, Offset.offset(0.0001))
            }

        @Test
        fun `API 실패 - 예외 처리하고 0점0 반환`() =
            runBlocking {
                coEvery { geminiApiClient.embedText(any(), any()) } throws RuntimeException("API Error")

                val result = service.cosineSimilarity("사과", "과일")

                assertThat(result).isCloseTo(0.0, Offset.offset(0.0001))
            }

        @Test
        fun `벡터 차원 불일치 - IllegalArgumentException`() =
            runBlocking {
                val vec1 = FloatArray(1536) { 1.0f }
                val vec2 = FloatArray(100) { 1.0f } // 다른 차원

                coEvery { geminiApiClient.embedText("사과", 1536) } returns vec1
                coEvery { geminiApiClient.embedText("과일", 1536) } returns vec2

                // calculateCosineSimilarity에서 require 실패하여 예외 발생
                // 하지만 cosineSimilarity는 try-catch로 0.0 반환
                val result = service.cosineSimilarity("사과", "과일")

                assertThat(result).isCloseTo(0.0, Offset.offset(0.0001))
            }
    }
}
