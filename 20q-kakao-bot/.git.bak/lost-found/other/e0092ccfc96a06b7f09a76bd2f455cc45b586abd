package party.qwer.twentyq.service.gemini

import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import party.qwer.twentyq.ai.ResponseSchema
import party.qwer.twentyq.ai.cache.GeminiCacheRegistry
import party.qwer.twentyq.config.AppProperties
import party.qwer.twentyq.service.GeminiApiClient
import party.qwer.twentyq.service.GeminiApiKeyProvider

@Component
class GeminiGenerationFacade(
    private val apiClient: GeminiApiClient,
    private val cacheRegistry: GeminiCacheRegistry,
    private val appProperties: AppProperties,
    private val keyProvider: GeminiApiKeyProvider,
) {
    private val log = LoggerFactory.getLogger(javaClass)



    @Suppress("TooGenericExceptionCaught")
    suspend fun generate(req: GenerationRequest): String {
        val effectiveBudget = apiClient.effectiveThinkingBudget(req.model, req.thinkingBudget)
        val config = appProperties.ai.gemini

        val apiKey = keyProvider.availableKeyOrNull()
        val cacheId = if (apiKey != null) cacheRegistry.getCacheIdForKey(req.operation, apiKey) else null

        if (config.cacheEnabled && cacheId != null && apiKey != null) {
            try {
                log.info(
                    "GeminiGenerationFacade CACHE mode op={}, model={}, thinkingBudgetBase={}, thinkingBudgetEffective={}, cacheId={}",
                    req.operation,
                    req.model,
                    req.thinkingBudget,
                    effectiveBudget,
                    cacheId,
                )
                return apiClient.generateWithCache(
                    model = req.model,
                    cacheId = cacheId,
                    userPrompt = req.userPrompt,
                    temperature = req.temperature,
                    topP = req.topP,
                    thinkingBudget = req.thinkingBudget,
                    schema = req.schema,
                    apiKey = apiKey,
                )
            } catch (e: Exception) {
                log.warn("GeminiGenerationFacade CACHE fallback for op={}: {}", req.operation, e.message)
            }
        }

        log.info(
            "GeminiGenerationFacade THINKING mode op={}, model={}, thinkingBudgetBase={}, thinkingBudgetEffective={}",
            req.operation,
            req.model,
            req.thinkingBudget,
            effectiveBudget,
        )

        return apiClient.generateWithThinking(
            model = req.model,
            systemPrompt = req.systemPrompt ?: "",
            userPrompt = req.userPrompt,
            temperature = req.temperature,
            topP = req.topP,
            thinkingBudget = req.thinkingBudget,
            schema = req.schema,
        )
    }
}
