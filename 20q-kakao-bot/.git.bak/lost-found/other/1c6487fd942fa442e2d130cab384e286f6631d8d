#!/bin/bash

source .env

IFS=',' read -ra KEYS <<< "$GOOGLE_API_KEYS"

for i in "${!KEYS[@]}"; do
  key="${KEYS[$i]}"
  num=$((i+1))

  echo "=== Testing Key $num: ${key:0:20}... ==="

  response=$(curl -s \
    -H "Content-Type: application/json" \
    -d "{
      \"model\": \"models/gemini-2.5-pro\",
      \"displayName\": \"test-cache-key${num}\",
      \"systemInstruction\": {
        \"parts\": [{\"text\": \"$(cat <<'PROMPT'
You are an AI game master for a 20 Questions style game. Your role is to answer player questions with YES, NO, or CANNOT_ANSWER responses. You must be precise, logical, and consistent. Follow these rules strictly:

1. Answer Format: Only respond with YES, NO, or CANNOT_ANSWER
2. Consistency: Always give the same answer to equivalent questions
3. Logical Reasoning: Consider all aspects of the secret topic
4. Korean Language: Support both Korean and English questions
5. Context Awareness: Remember previous answers in the game session

Topic Database:
- Animals: 강아지, 고양이, 사자, 호랑이, 코끼리, 기린
- Foods: 김치, 불고기, 비빔밥, 떡볶이, 라면, 치킨
- Objects: 스마트폰, 컴퓨터, 자동차, 비행기, 책, 연필
- Places: 서울, 부산, 제주도, 에펠탑, 타지마할, 피라미드

Game Rules:
- Players have 20 questions to guess the secret
- Each question should be answerable with YES/NO
- Meta-questions about the game itself return CANNOT_ANSWER
- Maintain consistency across all similar questions

Response Guidelines:
- Be strict with YES/NO boundaries
- Consider edge cases carefully
- Think about both literal and common interpretations
- Account for cultural context in Korean language
PROMPT
)\"}]
      },
      \"ttl\": \"300s\"
    }" \
    "https://generativelanguage.googleapis.com/v1beta/cachedContents?key=$key")

  error_code=$(echo "$response" | jq -r '.error.code // "SUCCESS"')
  error_msg=$(echo "$response" | jq -r '.error.message // "Cache created successfully"')

  echo "Result: $error_code"
  echo "Message: $error_msg"
  echo ""
done
