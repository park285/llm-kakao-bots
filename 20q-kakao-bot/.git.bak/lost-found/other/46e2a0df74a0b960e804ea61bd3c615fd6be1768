package party.qwer.twentyq.redis

import org.slf4j.LoggerFactory
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty
import org.springframework.stereotype.Component
import party.qwer.twentyq.redis.session.CategoryStore
import party.qwer.twentyq.redis.session.HistoryStore
import party.qwer.twentyq.redis.session.SessionStore
import party.qwer.twentyq.redis.tracking.HintCountStore
import party.qwer.twentyq.redis.tracking.PlayerSetStore
import party.qwer.twentyq.redis.tracking.TopicHistoryStore
import party.qwer.twentyq.redis.tracking.WrongGuessSetStore
import party.qwer.twentyq.redis.voting.BlindedTokensStore
import party.qwer.twentyq.redis.voting.SurrenderVoteStore

@Component
@ConditionalOnProperty(
    prefix = "app.redis",
    name = ["enabled"],
    havingValue = "true",
    matchIfMissing = true,
)
class SessionCoordinator(
    private val sessionStore: SessionStore,
    private val historyStore: HistoryStore,
    private val hintCountStore: HintCountStore,
    private val categoryStore: CategoryStore,
    private val playerSetStore: PlayerSetStore,
    private val wrongGuessSetStore: WrongGuessSetStore,
    private val blindedTokensStore: BlindedTokensStore,
    private val topicHistoryStore: TopicHistoryStore,
    private val surrenderVoteStore: SurrenderVoteStore,
) {
    companion object {
        private val log = LoggerFactory.getLogger(SessionCoordinator::class.java)
    }

    suspend fun deleteSession(roomId: String) {
        sessionStore.delete(roomId)
        historyStore.clearAsync(roomId)
        hintCountStore.deleteAsync(roomId)
        categoryStore.save(roomId, null)
        playerSetStore.clear(roomId)
        wrongGuessSetStore.delete(roomId)
        blindedTokensStore.deleteAllAsync(roomId)
        surrenderVoteStore.clear(roomId)

        log.debug("DELETE_SESSION room={}", roomId)
    }

    suspend fun clearAll(roomId: String) {
        deleteSession(roomId)
        topicHistoryStore.clearAll(roomId)

        log.info("CLEAR_ALL room={}", roomId)
    }
}
