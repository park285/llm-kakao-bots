package party.qwer.twentyq.bridge.handlers

import org.slf4j.LoggerFactory
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty
import org.springframework.stereotype.Component
import party.qwer.twentyq.service.RiddleService
import party.qwer.twentyq.service.exception.InvalidQuestionException
import party.qwer.twentyq.service.exception.SessionNotFoundException

@Component
@ConditionalOnProperty(prefix = "app.mqtt", name = ["enabled"], havingValue = "true", matchIfMissing = true)
class AskHandler(
    private val riddleService: RiddleService,
    private val startHandler: StartHandler,
    private val messageProvider: party.qwer.twentyq.util.GameMessageProvider,
) {
    private val log = LoggerFactory.getLogger(javaClass)

    suspend fun handle(
        chatId: String,
        question: String,
    ): String {
        log.info("HANDLE_ASK chatId={}, question='{}'", chatId, question.take(50))
        return try {
            requireSession(chatId)
            val result = riddleService.answer(chatId, question)

            if (result.isCorrect) {
                log.info("CORRECT_ANSWER chatId={}", chatId)
                result.successMessage ?: messageProvider.get("answer.correct_default")
            } else if (result.guardDegraded) {
                log.info("GUARD_BLOCKED chatId={}", chatId)
                messageProvider.get("error.invalid_question.default")
            } else {
                val statusMsg = startHandler.getStatusMessages(chatId)
                statusMsg.primary
            }
        } catch (ex: SessionNotFoundException) {
            messageProvider.get("error.no_session_short")
        } catch (ex: InvalidQuestionException) {
            log.info("INVALID_QUESTION chatId={}, question='{}'", chatId, question.take(50))
            ex.message ?: messageProvider.get("error.invalid_question.default")
        } catch (ex: Exception) {
            log.error("Failed to process ask", ex)
            messageProvider.get("error.generic_error")
        }
    }

    private fun requireSession(chatId: String) {
        if (!riddleService.hasSession(chatId)) {
            throw SessionNotFoundException()
        }
    }
}
