package party.qwer.twentyq.redis.voting

import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
import io.mockk.every
import io.mockk.mockk
import io.mockk.verify
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import org.springframework.data.redis.core.StringRedisTemplate
import org.springframework.data.redis.core.ValueOperations
import party.qwer.twentyq.config.AppProperties
import party.qwer.twentyq.model.SurrenderVote
import java.time.Duration

@DisplayName("Voting Store 테스트")
class VotingStoresTest {
    private lateinit var redis: StringRedisTemplate
    private lateinit var valueOps: ValueOperations<String, String>
    private lateinit var json: com.fasterxml.jackson.databind.ObjectMapper
    private lateinit var props: AppProperties

    @BeforeEach
    fun setUp() {
        redis = mockk(relaxed = true)
        valueOps = mockk(relaxed = true)
        json = jacksonObjectMapper()
        props = mockk(relaxed = true)

        every { redis.opsForValue() } returns valueOps
        every { props.redis.sessionTtlMinutes } returns 60L
    }

    @Nested
    @DisplayName("BlindedTokensStore")
    inner class BlindedTokensStoreTest {
        private lateinit var store: BlindedTokensStore

        @BeforeEach
        fun setUp() {
            store = BlindedTokensStore(redis, props, json)
        }

        @Test
        @DisplayName("get은 블라인드 토큰을 조회한다")
        fun shouldGetBlindedTokens() {
            // given
            val roomId = "room123"
            val hintNumber = 1
            val tokens = listOf("사과", "바나나")
            val tokensJson = json.writeValueAsString(tokens)

            every { valueOps.get("20q:blindedTokens:room123:1") } returns tokensJson

            // when
            val result = store.get(roomId, hintNumber)

            // then
            assertThat(result).containsExactly("사과", "바나나")
        }

        @Test
        @DisplayName("get은 값이 없으면 빈 리스트를 반환한다")
        fun shouldReturnEmptyListWhenTokensNotFound() {
            // given
            val roomId = "room123"
            val hintNumber = 1

            every { valueOps.get("20q:blindedTokens:room123:1") } returns null

            // when
            val result = store.get(roomId, hintNumber)

            // then
            assertThat(result).isEmpty()
        }

        @Test
        @DisplayName("save는 블라인드 토큰을 저장한다")
        fun shouldSaveBlindedTokens() {
            // given
            val roomId = "room123"
            val hintNumber = 1
            val tokens = listOf("토큰1", "토큰2")

            // when
            store.save(roomId, hintNumber, tokens)

            // then
            verify {
                valueOps.set(
                    "20q:blindedTokens:room123:1",
                    match { it.contains("토큰1") && it.contains("토큰2") },
                    Duration.ofMinutes(60),
                )
            }
        }

        @Test
        @DisplayName("update는 블라인드 토큰을 업데이트한다")
        fun shouldUpdateBlindedTokens() {
            // given
            val roomId = "room123"
            val hintNumber = 1
            val tokens = listOf("업데이트토큰")

            // when
            store.update(roomId, hintNumber, tokens)

            // then
            verify {
                valueOps.set(
                    "20q:blindedTokens:room123:1",
                    match { it.contains("업데이트토큰") },
                    Duration.ofMinutes(60),
                )
            }
        }

        @Test
        @DisplayName("delete는 특정 힌트의 블라인드 토큰을 삭제한다")
        fun shouldDeleteSpecificHintTokens() {
            // given
            val roomId = "room123"
            val hintNumber = 1

            // when
            store.delete(roomId, hintNumber)

            // then
            verify { redis.delete("20q:blindedTokens:room123:1") }
        }

        @Test
        @DisplayName("deleteAll은 모든 블라인드 토큰을 삭제한다")
        fun shouldDeleteAllTokens() {
            // given
            val roomId = "room123"

            // when
            store.deleteAll(roomId)

            // then
            // deleteAll은 패턴 매칭 후 삭제하므로 mock 검증 불가
            // 실제 통합 테스트에서 검증 필요
        }
    }

    @Nested
    @DisplayName("SurrenderVoteStore")
    inner class SurrenderVoteStoreTest {
        private lateinit var store: SurrenderVoteStore

        @BeforeEach
        fun setUp() {
            store = SurrenderVoteStore(redis, json)
        }

        @Test
        @DisplayName("get은 투표 정보를 조회한다")
        fun shouldGetSurrenderVote() {
            // given
            val roomId = "room123"
            val vote =
                SurrenderVote(
                    initiator = "user1",
                    eligiblePlayers = setOf("user1", "user2", "user3"),
                    approvals = setOf("user1", "user2"),
                )
            val voteJson = json.writeValueAsString(vote)

            every { valueOps.get("20q:surrender:vote:room123") } returns voteJson

            // when
            val result = store.get(roomId)

            // then
            assertThat(result).isNotNull
            assertThat(result?.initiator).isEqualTo("user1")
            assertThat(result?.eligiblePlayers).containsExactlyInAnyOrder("user1", "user2", "user3")
            assertThat(result?.approvals).containsExactlyInAnyOrder("user1", "user2")
            assertThat(result?.requiredApprovals()).isEqualTo(3)
        }

        @Test
        @DisplayName("get은 값이 없으면 null을 반환한다")
        fun shouldReturnNullWhenVoteNotFound() {
            // given
            val roomId = "room123"

            every { valueOps.get("20q:surrender:vote:room123") } returns null

            // when
            val result = store.get(roomId)

            // then
            assertThat(result).isNull()
        }

        @Test
        @DisplayName("save는 투표 정보를 저장한다")
        fun shouldSaveSurrenderVote() {
            // given
            val roomId = "room123"
            val vote =
                SurrenderVote(
                    initiator = "user1",
                    eligiblePlayers = setOf("user1", "user2", "user3"),
                    approvals = setOf("user1"),
                )

            // when
            store.save(roomId, vote)

            // then
            verify {
                valueOps.set(
                    "20q:surrender:vote:room123",
                    match { it.contains("user1") && it.contains("\"initiator\"") },
                    Duration.ofSeconds(120),
                )
            }
        }

        @Test
        @DisplayName("isActive는 투표가 활성화되어 있는지 확인한다")
        fun shouldCheckIfVoteIsActive() {
            // given
            val roomId = "room123"

            every { redis.hasKey("20q:surrender:vote:room123") } returns true

            // when
            val result = store.isActive(roomId)

            // then
            assertThat(result).isTrue()
        }

        @Test
        @DisplayName("isActive는 투표가 없으면 false를 반환한다")
        fun shouldReturnFalseWhenVoteNotActive() {
            // given
            val roomId = "room123"

            every { redis.hasKey("20q:surrender:vote:room123") } returns false

            // when
            val result = store.isActive(roomId)

            // then
            assertThat(result).isFalse()
        }

        @Test
        @DisplayName("approve는 찬성 투표를 기록한다")
        fun shouldApproveVote() {
            // given
            val roomId = "room123"
            val userId = "user1"
            val vote =
                SurrenderVote(
                    initiator = "initiator",
                    eligiblePlayers = setOf("user1", "user2", "initiator"),
                    approvals = setOf("user2"),
                )
            val voteJson = json.writeValueAsString(vote)

            every { valueOps.get("20q:surrender:vote:room123") } returns voteJson

            // when
            val result = store.approve(roomId, userId)

            // then
            assertThat(result).isNotNull
            assertThat(result?.approvals).contains("user1")
            verify {
                valueOps.set(
                    "20q:surrender:vote:room123",
                    match { it.contains("user1") },
                    Duration.ofSeconds(120),
                )
            }
        }

        @Test
        @DisplayName("clear는 투표 정보를 삭제한다")
        fun shouldClearVote() {
            // given
            val roomId = "room123"

            // when
            store.clear(roomId)

            // then
            verify { redis.delete("20q:surrender:vote:room123") }
        }
    }
}
