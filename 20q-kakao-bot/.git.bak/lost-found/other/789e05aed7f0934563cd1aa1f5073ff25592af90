package party.qwer.twentyq.ai.strategy

import org.springframework.stereotype.Component
import party.qwer.twentyq.ai.ResponseSchema
import party.qwer.twentyq.ai.ResponseSchemaUtils
import party.qwer.twentyq.config.AppProperties
import party.qwer.twentyq.service.gemini.GeminiGenerationFacade
import party.qwer.twentyq.service.gemini.GenerationRequest

@Component
class AnswerGenerationStrategy(
    private val generation: GeminiGenerationFacade,
    private val appProperties: AppProperties,
) : GenerationStrategy {
    override suspend fun generate(
        systemPrompt: String,
        userPrompt: String,
        temperature: Double,
        topP: Double,
        maxTokens: Int?,
        schema: ResponseSchema?,
    ): String {
        val config = appProperties.ai.gemini
        val answerModel = config.answerModel?.takeIf { it.isNotBlank() } ?: config.model
        val enumSchema = schema as? ResponseSchema.Enum

        val enhancedSystemPrompt =
            if (enumSchema != null) {
                ResponseSchemaUtils.buildEnumConstraintPrompt(systemPrompt, enumSchema)
            } else {
                systemPrompt
            }

        return generation.generate(
            GenerationRequest(
                operation = "answer",
                model = answerModel,
                systemPrompt = enhancedSystemPrompt,
                userPrompt = userPrompt,
                temperature = temperature,
                topP = topP,
                thinkingBudget = config.answerThinkingBudget,
                maxTokens = maxTokens,
                schema = schema,
            ),
        )
    }
}
