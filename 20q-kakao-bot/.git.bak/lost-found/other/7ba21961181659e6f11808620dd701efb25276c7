package party.qwer.twentyq.service.riddle.hint

import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.module.kotlin.readValue
import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import party.qwer.twentyq.ai.AIProvider
import party.qwer.twentyq.ai.ResponseSchema
import party.qwer.twentyq.config.AppProperties
import party.qwer.twentyq.config.RiddleConfigProvider
import party.qwer.twentyq.model.HintResponse
import party.qwer.twentyq.service.HintValidator
import party.qwer.twentyq.util.JsonResponseParser

@Component
class HintAIClient(
    private val aiProvider: AIProvider,
    private val hintValidator: HintValidator,
    private val riddleConfigProvider: RiddleConfigProvider,
    private val props: AppProperties,
    private val objectMapper: ObjectMapper,
) {
    companion object {
        private const val FIELD_HINTS = "hints"
        private val log = LoggerFactory.getLogger(HintAIClient::class.java)
    }

    suspend fun call(
        systemPrompt: String,
        userPrompt: String,
    ): String {
        val config = riddleConfigProvider.getConfig()
        val schema = createSchema()

        return aiProvider.generate(
            operation = FIELD_HINTS,
            systemPrompt = systemPrompt,
            userPrompt = userPrompt,
            temperature = config.temperature.hints,
            topP = config.topP.hints,
            schema = ResponseSchema.JsonSchema(schema),
        )
    }

    fun parse(
        roomId: String,
        aiResponse: String,
    ): List<String> {
        val schema = createSchema()

        return JsonResponseParser
            .parseAndValidateToType<HintResponse>(aiResponse, schema, objectMapper)
            .fold(
                onSuccess = { response ->
                    log.info("PARSE_SUCCESS room={}, hintsCount={}", roomId, response.hints.size)
                    response.hints.take(1)
                },
                onFailure = { e ->
                    log.warn("PARSE_FAILED room={}, error={}, fallback", roomId, e.message)
                    // Fallback: 단순 텍스트 파싱
                    aiResponse
                        .split("\\n")
                        .map { it.trim() }
                        .filter {
                            it.isNotBlank() && !it.contains("<thinking>") && !it.startsWith("{") &&
                                !it.startsWith("}")
                        }.take(1)
                },
            )
    }

    suspend fun validateIfEnabled(
        roomId: String,
        rawHints: List<String>,
        hintNumber: Int,
        target: String,
    ): List<String> =
        if (props.riddle.validation.enabled) {
            log.info("VALIDATION_ENABLED room={}, maxRetries={}", roomId, props.riddle.validation.maxRetries)
            rawHints.map { hint ->
                hintValidator.validateAndImproveHint(
                    hint = hint,
                    hintNumber = hintNumber,
                    target = target,
                    maxRetries = props.riddle.validation.maxRetries,
                )
            }
        } else {
            log.info("VALIDATION_DISABLED room={}", roomId)
            rawHints
        }

    private fun createSchema(): Map<String, Any> =
        mapOf(
            "type" to "object",
            "additionalProperties" to false,
            "properties" to
                mapOf(
                    FIELD_HINTS to
                        mapOf(
                            "type" to "array",
                            "items" to mapOf("type" to "string"),
                            "minItems" to 1,
                            "maxItems" to 1,
                        ),
                ),
            "required" to listOf(FIELD_HINTS),
        )

    private fun validateSchema(
        mapper: ObjectMapper,
        schema: Map<String, Any>,
        json: String,
        roomId: String,
    ) {
        try {
            val factory =
                com.networknt.schema.JsonSchemaFactory
                    .getInstance(com.networknt.schema.SpecVersion.VersionFlag.V202012)
            val schemaNode = mapper.readTree(mapper.writeValueAsString(schema))
            val schemaObj = factory.getSchema(schemaNode)
            val jsonNode = mapper.readTree(json)
            val errors = schemaObj.validate(jsonNode)
            if (errors.isNotEmpty()) {
                throw IllegalArgumentException("Invalid hint JSON: ${errors.first().message}")
            }
        } catch (ve: com.networknt.schema.JsonSchemaException) {
            log.warn("SCHEMA_INVALID room={}, error={}", roomId, ve.message)
            throw ve
        }
    }
}
