package party.qwer.twentyq.llm

import org.springframework.stereotype.Component
import party.qwer.twentyq.config.PromptResourcePaths

@Component
class RiddlePromptManager(
    private val promptLoader: PromptLoader,
) {
    private val prompts: RiddlePromptConfig by lazy {
        promptLoader.loadYamlAs(PromptResourcePaths.RIDDLE_CONFIG, RiddlePromptConfig::class.java)
    }

    private val personaDoc: PersonaConfig by lazy {
        promptLoader.loadYamlAs(PromptResourcePaths.RIDDLE_PERSONA, PersonaConfig::class.java)
    }

    private val guardDoc: GuardConfig by lazy {
        promptLoader.loadYamlAs(PromptResourcePaths.GUARD, GuardConfig::class.java)
    }

    private val sectionTemplates: MutableMap<String, PromptTemplate> = mutableMapOf()

    val guard: String by lazy {
        guardDoc.system
    }

    val persona: String by lazy {
        personaDoc.system
    }

    val compliance: String by lazy {
        personaDoc.compliance.reminder
    }

    private val combinedCache = java.util.concurrent.ConcurrentHashMap<String, String>()

    private fun sectionPath(section: String): String? =
        when (section) {
            SECTION_CREATE -> PromptResourcePaths.CREATE
            SECTION_HINTS -> PromptResourcePaths.HINTS
            SECTION_ANSWER -> PromptResourcePaths.ANSWER
            SECTION_REVEAL -> PromptResourcePaths.REVEAL
            SECTION_NORMALIZE -> PromptResourcePaths.NORMALIZE
            SECTION_HINTS_JSON -> PromptResourcePaths.HINTS_JSON
            SECTION_HINT_ESTIMATION -> PromptResourcePaths.HINT_ESTIMATION
            SECTION_SYNONYM_CHECK -> PromptResourcePaths.SYNONYM_CHECK
            SECTION_HINT_BLIND_JUDGMENT -> PromptResourcePaths.HINT_BLIND_JUDGMENT
            SECTION_TOPIC_DIFFICULTY -> PromptResourcePaths.TOPIC_DIFFICULTY
            else -> null
        }

    private fun loadSectionTemplate(section: String): PromptTemplate? {
        val cached = sectionTemplates[section]
        if (cached != null) return cached
        val path = sectionPath(section) ?: return null
        return try {
            val tpl = promptLoader.loadYamlAs(path, PromptTemplate::class.java)
            sectionTemplates[section] = tpl
            tpl
        } catch (e: Exception) {
            null
        }
    }

    fun getTemplate(
        section: String,
        key: String,
    ): String {
        val template =
            loadSectionTemplate(section) ?: when (section) {
                SECTION_CREATE -> prompts.create
                SECTION_HINTS -> prompts.hints
                SECTION_ANSWER -> prompts.answer
                SECTION_REVEAL -> prompts.reveal
                SECTION_NORMALIZE -> prompts.normalize
                SECTION_HINTS_JSON -> prompts.hintsJson
                SECTION_HINT_ESTIMATION -> prompts.hintEstimation
                else -> throw PromptNotFoundException(section, key)
            }

        return when (key) {
            KEY_SYSTEM -> template.system
            KEY_USER -> template.user
            else -> throw PromptNotFoundException(section, key)
        }
    }

    fun buildCombinedSystemPrompt(sectionSystemPrompt: String): String =
        combinedCache.computeIfAbsent(sectionSystemPrompt) {
            val hasOwnPersona = sectionSystemPrompt.contains("=== PERSONA")
            listOf(
                guard,
                if (hasOwnPersona) "" else persona,
                sectionSystemPrompt,
                compliance,
            ).filter { it.isNotBlank() }
                .joinToString("\n\n")
        }

    fun getSystemPrompt(section: String): String = getTemplate(section, KEY_SYSTEM)

    fun getUserPrompt(section: String): String = getTemplate(section, KEY_USER)

    companion object {


        private const val SECTION_CREATE = "create"
        const val SECTION_HINTS = "hints"
        private const val SECTION_ANSWER = "answer"
        private const val SECTION_REVEAL = "reveal"
        private const val SECTION_NORMALIZE = "normalize"
        private const val SECTION_HINTS_JSON = "hints_json"
        private const val SECTION_HINT_ESTIMATION = "hint_estimation"
        private const val SECTION_SYNONYM_CHECK = "synonym-check"
        private const val SECTION_HINT_BLIND_JUDGMENT = "hint_blind_judgment"
        private const val SECTION_TOPIC_DIFFICULTY = "topic-difficulty"

        private const val KEY_SYSTEM = "system"
        private const val KEY_USER = "user"
    }
}
