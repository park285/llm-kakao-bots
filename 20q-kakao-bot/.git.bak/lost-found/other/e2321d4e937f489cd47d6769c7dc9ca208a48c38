package party.qwer.twentyq.redis

import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import party.qwer.twentyq.model.PendingMessage
import party.qwer.twentyq.redis.queue.PendingMessageStore

// MessageQueueCoordinator - SessionCoordinator 패턴 준수
@Component
class MessageQueueCoordinator(
    private val pendingMessageStore: PendingMessageStore,
) {
    companion object {
        private val log = LoggerFactory.getLogger(MessageQueueCoordinator::class.java)
    }

    suspend fun enqueue(
        chatId: String,
        message: PendingMessage,
    ): Boolean {
        val result = pendingMessageStore.enqueue(chatId, message)
        if (!result) {
            log.warn("ENQUEUE_FAILED chatId={}, userId={}, reason=QUEUE_FULL", chatId, message.userId)
        }
        return result
    }

    suspend fun dequeueAll(chatId: String): List<PendingMessage> = pendingMessageStore.dequeueAll(chatId)

    suspend fun peek(chatId: String): PendingMessage? = pendingMessageStore.peek(chatId)

    suspend fun hasMessages(chatId: String): Boolean = pendingMessageStore.size(chatId) > 0

    suspend fun size(chatId: String): Int = pendingMessageStore.size(chatId)

    suspend fun clear(chatId: String) {
        pendingMessageStore.clear(chatId)
        log.debug("QUEUE_CLEARED chatId={}", chatId)
    }
}
