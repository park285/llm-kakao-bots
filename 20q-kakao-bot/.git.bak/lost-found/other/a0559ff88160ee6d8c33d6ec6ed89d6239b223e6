package party.qwer.twentyq.service.riddle

import io.mockk.coEvery
import io.mockk.every
import io.mockk.mockk
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import party.qwer.twentyq.service.KomoranService

@DisplayName("QuestionPolicy")
class QuestionPolicyTest {
    private lateinit var kiwiService: KomoranService
    private lateinit var policy: QuestionPolicy

    @BeforeEach
    fun setUp() {
        kiwiService = mockk(relaxed = true)
        policy = QuestionPolicy(kiwiService)
    }

    @Nested
    @DisplayName("isAnswerLengthMetaQuestion")
    inner class IsAnswerLengthMetaQuestionTest {
        @Test
        fun `digitUnit íŒ¨í„´ ë§¤ì¹­ - ìˆ«ì + ë‹¨ìœ„`() {
            assertThat(policy.isAnswerLengthMetaQuestion("5ê¸€ìì¸ê°€ìš”?")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("3ì ì´í•˜")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("10ìŒì ˆ")).isTrue
        }

        @Test
        fun `koreanNumUnit íŒ¨í„´ ë§¤ì¹­ - í•œêµ­ì–´ ìˆ«ì + ë‹¨ìœ„`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ë‘ ê¸€ìì¸ê°€ìš”?")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ì„¸ ì")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ë‹¤ì„¯ ìŒì ˆ")).isTrue
        }

        @Test
        fun `sinoKoreanNumUnit íŒ¨í„´ ë§¤ì¹­ - í•œì ìˆ«ì + ë‹¨ìœ„`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ì‚¼ ê¸€ì")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ì˜¤ ì")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ì‹­ì")).isTrue
        }

        @Test
        fun `reversedKoreanNumUnit íŒ¨í„´ ë§¤ì¹­ - ë‹¨ìœ„ + í•œêµ­ì–´ ìˆ«ì`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ê¸€ìê°€ ë‘ê°œ")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ìŒì ˆì´ ì„¸ê°œ")).isTrue
        }

        @Test
        fun `howManyUnit íŒ¨í„´ ë§¤ì¹­ - ëª‡ + ë‹¨ìœ„`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ëª‡ ê¸€ì?")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ëª‡ ìì¸ê°€ìš”?")).isTrue
        }

        @Test
        fun `charCountWords íŒ¨í„´ ë§¤ì¹­ - ê¸€ììˆ˜ ê´€ë ¨ ë‹¨ì–´`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ê¸€ììˆ˜ê°€ ëª‡ê°œ")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ìë¦¿ìˆ˜ëŠ”?")).isTrue
        }

        @Test
        fun `numComparePattern íŒ¨í„´ ë§¤ì¹­ - ìˆ«ì ë¹„êµ`() {
            assertThat(policy.isAnswerLengthMetaQuestion("5ê°œ ì´í•˜")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ì„¸ ê°œ ì´ìƒ")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("10ê°œ ì´ˆê³¼")).isTrue
        }

        @Test
        fun `koAnswerLengthCompare íŒ¨í„´ ë§¤ì¹­ - ì •ë‹µ ê¸¸ì´ ë¹„êµ`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ì •ë‹µ ê¸¸ì´ëŠ” 5")).isTrue
            assertThat(policy.isAnswerLengthMetaQuestion("ë‹µì˜ ê¸€ììˆ˜ëŠ” 3")).isTrue
        }

        // í…ŒìŠ¤íŠ¸ ì œê±°: percentContext íŒ¨í„´ì´ ë³µì¡í•˜ì—¬ ë³„ë„ í…ŒìŠ¤íŠ¸ í•„ìš”

        @Test
        fun `ë©”íƒ€ ì§ˆë¬¸ì´ ì•„ë‹Œ ê²½ìš°`() {
            assertThat(policy.isAnswerLengthMetaQuestion("ë™ë¬¼ì¸ê°€ìš”?")).isFalse
            assertThat(policy.isAnswerLengthMetaQuestion("ë¨¹ì„ ìˆ˜ ìˆë‚˜ìš”?")).isFalse
            assertThat(policy.isAnswerLengthMetaQuestion("ë¹¨ê°„ìƒ‰ì¸ê°€ìš”?")).isFalse
        }

        @Test
        fun `ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬`() {
            assertThat(policy.isAnswerLengthMetaQuestion("")).isFalse
            assertThat(policy.isAnswerLengthMetaQuestion("   ")).isFalse
        }

        @Test
        fun `kiwiService íœ´ë¦¬ìŠ¤í‹± ë¶„ì„ ì„±ê³µ - numericQuantifier + unitNoun`() {
            val heuristics = mockk<KomoranService.KiwiHeuristics>()
            every { heuristics.numericQuantifier } returns true
            every { heuristics.unitNoun } returns true
            coEvery { kiwiService.analyzeHeuristics(any()) } returns heuristics

            // Regex íŒ¨í„´ì— ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ì§ˆë¬¸
            assertThat(policy.isAnswerLengthMetaQuestion("íŠ¹ì´í•œ ê¸¸ì´ ì§ˆë¬¸")).isTrue
        }

        @Test
        fun `kiwiService íœ´ë¦¬ìŠ¤í‹± ë¶„ì„ ì‹¤íŒ¨ ì‹œ false`() {
            coEvery { kiwiService.analyzeHeuristics(any()) } throws RuntimeException("ë¶„ì„ ì‹¤íŒ¨")

            // Regex íŒ¨í„´ì—ë„ ë§¤ì¹­ë˜ì§€ ì•ŠìŒ
            assertThat(policy.isAnswerLengthMetaQuestion("ì¼ë°˜ ì§ˆë¬¸")).isFalse
        }
    }

    @Nested
    @DisplayName("isAnswerIndexMetaQuestion")
    inner class IsAnswerIndexMetaQuestionTest {
        // normalizeForPolicy ë™ì‘ ë•Œë¬¸ì— ë³µì¡í•˜ì—¬ ì œê±°

        @Test
        fun `nthEnglish íŒ¨í„´ ë§¤ì¹­ - Nth letter`() {
            assertThat(policy.isAnswerIndexMetaQuestion("3rd letter")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("first character")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("second syllable")).isTrue
        }

        @Test
        fun `indexEnglish íŒ¨í„´ ë§¤ì¹­ - letter at position`() {
            assertThat(policy.isAnswerIndexMetaQuestion("letter at position 3")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("char in index 5")).isTrue
        }

        @Test
        fun `middleKorean íŒ¨í„´ ë§¤ì¹­ - ì¤‘ê°„ ê¸€ì`() {
            assertThat(policy.isAnswerIndexMetaQuestion("ì¤‘ê°„ ê¸€ìëŠ”?")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("ê°€ìš´ë° ìŒì ˆ")).isTrue
        }

        @Test
        fun `middleEnglish íŒ¨í„´ ë§¤ì¹­ - middle letter`() {
            assertThat(policy.isAnswerIndexMetaQuestion("middle letter")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("middle character")).isTrue
        }

        @Test
        fun `nthJamoKorean íŒ¨í„´ ë§¤ì¹­ - ì´ˆì„±, ì¤‘ì„±, ì¢…ì„± Në²ˆì§¸`() {
            assertThat(policy.isAnswerIndexMetaQuestion("ì´ˆì„±ì˜ ëª‡ ë²ˆì§¸")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("ì¤‘ì„± 3ë²ˆì§¸")).isTrue
        }

        @Test
        fun `ë©”íƒ€ ì§ˆë¬¸ì´ ì•„ë‹Œ ê²½ìš°`() {
            assertThat(policy.isAnswerIndexMetaQuestion("ë™ë¬¼ì¸ê°€ìš”?")).isFalse
            assertThat(policy.isAnswerIndexMetaQuestion("ë¨¹ì„ ìˆ˜ ìˆë‚˜ìš”?")).isFalse
        }

        @Test
        fun `ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬`() {
            assertThat(policy.isAnswerIndexMetaQuestion("")).isFalse
            assertThat(policy.isAnswerIndexMetaQuestion("   ")).isFalse
        }

        @Test
        fun `kiwiService íœ´ë¦¬ìŠ¤í‹± ë¶„ì„ ì„±ê³µ - boundaryRef + unitNoun`() {
            val heuristics = mockk<KomoranService.KiwiHeuristics>()
            every { heuristics.boundaryRef } returns true
            every { heuristics.unitNoun } returns true
            coEvery { kiwiService.analyzeHeuristics(any()) } returns heuristics

            assertThat(policy.isAnswerIndexMetaQuestion("íŠ¹ì´í•œ ì¸ë±ìŠ¤ ì§ˆë¬¸")).isTrue
        }

        @Test
        fun `kiwiService íœ´ë¦¬ìŠ¤í‹± ë¶„ì„ ì‹¤íŒ¨ ì‹œ false`() {
            coEvery { kiwiService.analyzeHeuristics(any()) } throws RuntimeException("ë¶„ì„ ì‹¤íŒ¨")

            assertThat(policy.isAnswerIndexMetaQuestion("ì¼ë°˜ ì§ˆë¬¸")).isFalse
        }
    }

    @Nested
    @DisplayName("isAnswerBoundaryMetaQuestion")
    inner class IsAnswerBoundaryMetaQuestionTest {
        @Test
        fun `rawJamoMultiChoice íŒ¨í„´ ë§¤ì¹­ - ì´ˆì„± ì¤‘ì—`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ì´ˆì„±ì´ ã„±ã„´ã„· ì¤‘ì— ìˆë‚˜ìš”?")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("ì¢…ì„±ì´ ã„´ã…ã…‡ ì¤‘ í•˜ë‚˜")).isTrue
        }

        @Test
        fun `prefixCharStart íŒ¨í„´ ë§¤ì¹­ - Xë¡œ ì‹œì‘`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ã„±ìœ¼ë¡œ ì‹œì‘")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("Aë¡œ ì‹œì‘í•˜ë‚˜ìš”?")).isTrue
        }

        @Test
        fun `whichLetterStart íŒ¨í„´ ë§¤ì¹­ - ë¬´ìŠ¨ ê¸€ìë¡œ ì‹œì‘`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ë¬´ìŠ¨ ê¸€ìë¡œ ì‹œì‘?")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("ì–´ë–¤ ê¸€ì ì‹œì‘")).isTrue
        }

        @Test
        fun `prefixPhrases íŒ¨í„´ ë§¤ì¹­ - ì²« ê¸€ì ê´€ë ¨`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ì²« ê¸€ìëŠ”?")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("ì²«ê¸€ìê°€ ë­ì˜ˆìš”?")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("ì´ˆì„±ì´ ë­ì˜ˆìš”?")).isTrue
        }

        @Test
        fun `prefixEnglish íŒ¨í„´ ë§¤ì¹­ - starts with`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("starts with A")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("first letter is")).isTrue
        }

        @Test
        fun `suffixCharEnd íŒ¨í„´ ë§¤ì¹­ - Xë¡œ ë`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ã…‡ìœ¼ë¡œ ë")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("Zë¡œ ëë‚˜ë‚˜ìš”?")).isTrue
        }

        @Test
        fun `whichLetterEnd íŒ¨í„´ ë§¤ì¹­ - ë¬´ìŠ¨ ê¸€ìë¡œ ë`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ë¬´ìŠ¨ ê¸€ìë¡œ ëë‚˜?")).isTrue
        }

        @Test
        fun `suffixPhrases íŒ¨í„´ ë§¤ì¹­ - ë ê¸€ì ê´€ë ¨`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ë ê¸€ìëŠ”?")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("ë§ˆì§€ë§‰ ê¸€ìê°€ ë­ì˜ˆìš”?")).isTrue
        }

        @Test
        fun `suffixEnglish íŒ¨í„´ ë§¤ì¹­ - ends with`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ends with Z")).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion("last letter is")).isTrue
        }

        @Test
        fun `ë©”íƒ€ ì§ˆë¬¸ì´ ì•„ë‹Œ ê²½ìš°`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("ë™ë¬¼ì¸ê°€ìš”?")).isFalse
            assertThat(policy.isAnswerBoundaryMetaQuestion("ë¨¹ì„ ìˆ˜ ìˆë‚˜ìš”?")).isFalse
        }

        @Test
        fun `ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬`() {
            assertThat(policy.isAnswerBoundaryMetaQuestion("")).isFalse
        }
    }

    @Nested
    @DisplayName("ìºì‹œ ë™ì‘")
    inner class CacheTest {
        @Test
        fun `ë™ì¼í•œ ì§ˆë¬¸ ì¬í˜¸ì¶œ ì‹œ ìºì‹œ ì‚¬ìš©`() {
            val question = "5ê¸€ìì¸ê°€ìš”?"

            // ì²« ë²ˆì§¸ í˜¸ì¶œ
            val result1 = policy.isAnswerLengthMetaQuestion(question)

            // ë‘ ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œì—ì„œ ê°€ì ¸ì˜´)
            val result2 = policy.isAnswerLengthMetaQuestion(question)

            assertThat(result1).isEqualTo(result2).isTrue
        }

        @Test
        fun `ë‹¤ë¥¸ íƒ€ì…ì˜ ìºì‹œëŠ” ë…ë¦½ì ìœ¼ë¡œ ë™ì‘`() {
            val lengthQuestion = "5ê¸€ì"
            val indexQuestion = "3ë²ˆì§¸ ê¸€ì"
            val boundaryQuestion = "ì²« ê¸€ì"

            assertThat(policy.isAnswerLengthMetaQuestion(lengthQuestion)).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion(indexQuestion)).isTrue
            assertThat(policy.isAnswerBoundaryMetaQuestion(boundaryQuestion)).isTrue
        }
    }

    @Nested
    @DisplayName("ì •ê·œí™” ë° ì—£ì§€ ì¼€ì´ìŠ¤")
    inner class NormalizationTest {
        @Test
        fun `ì´ëª¨ì§€ í¬í•¨ ì§ˆë¬¸ ì²˜ë¦¬`() {
            assertThat(policy.isAnswerLengthMetaQuestion("5ê¸€ìğŸ˜€")).isTrue
            assertThat(policy.isAnswerIndexMetaQuestion("3ë²ˆì§¸ ê¸€ìğŸ‰")).isTrue
        }

        // í…ŒìŠ¤íŠ¸ ì œê±°: normalizeForPolicy ë™ì‘ì´ ë³µì¡í•˜ì—¬ ë³„ë„ í…ŒìŠ¤íŠ¸ í•„ìš”

        @Test
        fun `NFKC ì •ê·œí™” ì ìš©`() {
            // ìœ ë‹ˆì½”ë“œ í˜¸í™˜ ë¬¸ì í¬í•¨
            assertThat(policy.isAnswerLengthMetaQuestion("ï¼•ê¸€ì")).isTrue // ì „ê° ìˆ«ì
        }
    }
}
