package party.qwer.twentyq.util.hint

import org.slf4j.LoggerFactory
import party.qwer.twentyq.service.KomoranService

class HintBlindServiceImpl(
    private val selector: HintBlindSelector,
    private val rewriter: HintBlindRewriter,
    private val kiwiService: KomoranService,
) : HintBlindService {
    companion object {
        private val log = LoggerFactory.getLogger(HintBlindServiceImpl::class.java)
    }

    override suspend fun blindTargetInHints(
        hints: List<String>,
        target: String,
        category: String?,
    ): List<Pair<String, List<String>>> =
        hints.map { hint ->
            try {
                val (tokensToBlind, tokens) = selector.selectBlindToken(hint, target, category)
                if (tokensToBlind.isEmpty()) {
                    log.warn("blindTargetInHints NO_TOKENS hint='{}'", hint)
                    hint to emptyList()
                } else {
                    val (blinded, actualTokens) = rewriter.blindMultipleTokensWithSuffix(hint, tokensToBlind, tokens)
                    log.info("blindTargetInHints SUCCESS blinded='{}', tokens={}", blinded, tokensToBlind)
                    blinded to actualTokens
                }
            } catch (e: Exception) {
                log.error("blindTargetInHints FAILED hint='{}' error={}", hint, e.message, e)
                val tokens = kiwiService.analyze(hint)
                val containsTarget = tokens.any { it.form == target }
                if (containsTarget) {
                    val (blinded, actual) = rewriter.blindTokenWithSuffix(hint, target, tokens)
                    blinded to listOf(actual)
                } else {
                    hint to emptyList()
                }
            }
        }

    override fun revealBlindInHints(
        hints: List<String>,
        blindedTokensList: List<List<String>>,
    ): List<String> = rewriter.revealBlindInHints(hints, blindedTokensList)

    override fun revealTokens(
        hint: String,
        blindedTokens: List<String>,
        revealCount: Int,
    ): HintBlindService.RevealOutcome {
        val toReveal = blindedTokens.take(revealCount)
        val remaining = blindedTokens.drop(revealCount)
        val updated = rewriter.revealTokens(hint, toReveal, toReveal.size)
        return HintBlindService.RevealOutcome(
            updatedHint = updated,
            revealedTokens = toReveal,
            remainingTokens = remaining,
        )
    }
}
