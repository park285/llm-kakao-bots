package party.qwer.twentyq.redis.session

import org.slf4j.LoggerFactory
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty
import org.springframework.stereotype.Component
import party.qwer.twentyq.model.RiddleSecret

@Component
@ConditionalOnProperty(
    prefix = "app.redis",
    name = ["enabled"],
    havingValue = "true",
    matchIfMissing = true,
)
class SecretStore(
    private val sessionStore: SessionStore,
) {
    companion object {
        private val log = LoggerFactory.getLogger(SecretStore::class.java)
    }

    @Suppress("TooGenericExceptionCaught")
    fun get(roomId: String): RiddleSecret? {
        val data = sessionStore.get(roomId) ?: return null
        return try {
            RiddleSecret.fromJson(data)
        } catch (e: Exception) {
            log.error("PARSE_ERROR room={}, error={}", roomId, e.message, e)
            null
        }
    }

    fun save(
        roomId: String,
        secret: RiddleSecret,
    ) {
        val data = secret.toJson()
        sessionStore.save(roomId, data)
        log.debug("SAVE room={}, target='{}', category='{}'", roomId, secret.target, secret.category)
    }
}
