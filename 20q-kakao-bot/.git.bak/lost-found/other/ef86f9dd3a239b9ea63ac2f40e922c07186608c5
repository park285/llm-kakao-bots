package party.qwer.twentyq.bridge.handlers

import io.mockk.every
import io.mockk.mockk
import kotlinx.coroutines.runBlocking
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test
import party.qwer.twentyq.api.dto.HintHistory
import party.qwer.twentyq.api.dto.QuestionHistory
import party.qwer.twentyq.api.dto.RiddleStatusResponse
import party.qwer.twentyq.config.AppProperties
import party.qwer.twentyq.redis.RiddleSessionRepository
import party.qwer.twentyq.service.RiddleService
import party.qwer.twentyq.util.IrisClient

class StartHandlerTest {
    @Test
    fun `handle returns status header when session exists`() =
        runBlocking {
            val riddleService = mockk<RiddleService>()
            val sessionRepo = mockk<RiddleSessionRepository>(relaxed = true)
            val iris = mockk<IrisClient>(relaxed = true)
            val appProps = mockk<AppProperties>(relaxed = true)

            every { riddleService.hasSession("room-2") } returns true
            every { riddleService.getStatus("room-2") } returns
                RiddleStatusResponse(
                    questionCount = 0,
                    questions = emptyList<QuestionHistory>(),
                    hints = emptyList<HintHistory>(),
                    hintCount = 0,
                    maxHints = 3,
                    selectedCategory = null,
                )

            val handler = StartHandler(riddleService, sessionRepo, appProps)
            val result = handler.handle("room-2")

            assertTrue(result.contains("남은힌트3"))
        }
}
