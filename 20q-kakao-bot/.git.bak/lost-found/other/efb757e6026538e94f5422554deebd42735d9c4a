package party.qwer.twentyq.api

import io.mockk.coEvery
import io.mockk.every
import io.mockk.mockk
import jakarta.servlet.http.HttpServletRequest
import kotlinx.coroutines.runBlocking
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import org.springframework.http.HttpStatus
import party.qwer.twentyq.api.dto.HintHistory
import party.qwer.twentyq.api.dto.QuestionHistory
import party.qwer.twentyq.api.dto.RiddleAnswerRequest
import party.qwer.twentyq.api.dto.RiddleCreateRequest
import party.qwer.twentyq.api.dto.RiddleHintsRequest
import party.qwer.twentyq.api.dto.RiddleStatusResponse
import party.qwer.twentyq.model.FiveScaleKo
import party.qwer.twentyq.service.RiddleService
import party.qwer.twentyq.service.dto.AnswerResult
import party.qwer.twentyq.service.dto.AnswerSource
import party.qwer.twentyq.service.riddle.model.HintResult

@DisplayName("RiddleController 테스트")
class RiddleControllerTest {
    private lateinit var riddleService: RiddleService
    private lateinit var controller: RiddleController
    private lateinit var request: HttpServletRequest

    @BeforeEach
    fun setup() {
        riddleService = mockk(relaxed = true)
        controller = RiddleController(riddleService)
        request = mockk(relaxed = true)
        every { request.remoteAddr } returns "127.0.0.1"
    }

    @Nested
    @DisplayName("POST /api/twentyq/riddle/create")
    inner class CreateTests {
        @Test
        fun `정상 케이스 - 카테고리 없이 생성`() =
            runBlocking {
                coEvery { riddleService.createRiddle("test-chat", null) } returns "새 게임이 시작되었습니다!"

                val response = controller.create("test-chat", null, request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.message).isEqualTo("새 게임이 시작되었습니다!")
            }

        @Test
        fun `정상 케이스 - 카테고리 지정`() =
            runBlocking {
                val req = RiddleCreateRequest(category = "FOOD")
                coEvery { riddleService.createRiddle("test-chat", "FOOD") } returns "음식 카테고리로 게임을 시작합니다!"

                val response = controller.create("test-chat", req, request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.message).isEqualTo("음식 카테고리로 게임을 시작합니다!")
            }

        @Test
        fun `헤더 없이 요청 - IP 기반 chatId 사용`() =
            runBlocking {
                coEvery { riddleService.createRiddle(any(), null) } returns "게임 시작!"

                val response = controller.create(null, null, request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.message).isEqualTo("게임 시작!")
            }
    }

    @Nested
    @DisplayName("POST /api/twentyq/riddle/hints")
    inner class HintsTests {
        @Test
        fun `정상 케이스 - Generated 힌트`() =
            runBlocking {
                val hintResult = HintResult.Generated(hintNumber = 1, content = "힌트1", remainingBlinds = 3)
                coEvery { riddleService.generateHints("test-chat", 1) } returns hintResult

                val response = controller.hints("test-chat", RiddleHintsRequest(count = 1), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.hints).hasSize(1)
                assertThat(response.body?.hints?.get(0)).isEqualTo("힌트1")
            }

        @Test
        fun `정상 케이스 - PartiallyRevealed 힌트`() =
            runBlocking {
                val hintResult = HintResult.PartiallyRevealed(hintNumber = 2, content = "힌트2", remainingBlinds = 1)
                coEvery { riddleService.generateHints("test-chat", 2) } returns hintResult

                val response = controller.hints("test-chat", RiddleHintsRequest(count = 2), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.hints?.get(0)).isEqualTo("힌트2")
            }

        @Test
        fun `정상 케이스 - FullyRevealed 힌트`() =
            runBlocking {
                val hintResult = HintResult.FullyRevealed(hintNumber = 3, content = "힌트3")
                coEvery { riddleService.generateHints("test-chat", 3) } returns hintResult

                val response = controller.hints("test-chat", RiddleHintsRequest(count = 3), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.hints?.get(0)).isEqualTo("힌트3")
            }

        @Test
        fun `정상 케이스 - NotAvailable 힌트`() =
            runBlocking {
                coEvery { riddleService.generateHints("test-chat", 1) } returns HintResult.NotAvailable

                val response = controller.hints("test-chat", RiddleHintsRequest(count = 1), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.hints).isEmpty()
            }

        @Test
        fun `count가 범위 초과 - IllegalArgumentException`() =
            runBlocking {
                var exception: Exception? = null
                try {
                    controller.hints("test-chat", RiddleHintsRequest(count = 11), request)
                } catch (e: IllegalArgumentException) {
                    exception = e
                }

                assertThat(exception).isInstanceOf(IllegalArgumentException::class.java)
                assertThat(exception?.message).contains("count must be between 1 and 10")
            }

        @Test
        fun `count가 0 - IllegalArgumentException`() =
            runBlocking {
                var exception: Exception? = null
                try {
                    controller.hints("test-chat", RiddleHintsRequest(count = 0), request)
                } catch (e: IllegalArgumentException) {
                    exception = e
                }

                assertThat(exception).isInstanceOf(IllegalArgumentException::class.java)
            }
    }

    @Nested
    @DisplayName("POST /api/twentyq/riddle/answer")
    inner class AnswerTests {
        @Test
        fun `정상 케이스 - ALWAYS_YES 응답`() =
            runBlocking {
                val answerResult =
                    AnswerResult(
                        scale = FiveScaleKo.ALWAYS_YES,
                        source = AnswerSource.ENUM_SCHEMA_PRIMARY,
                        guardDegraded = false,
                    )
                coEvery { riddleService.answer("test-chat", "사과인가요?") } returns answerResult

                val response = controller.answer("test-chat", RiddleAnswerRequest("사과인가요?"), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.scale).isEqualTo("예")
            }

        @Test
        fun `정상 케이스 - ALWAYS_NO 응답`() =
            runBlocking {
                val answerResult =
                    AnswerResult(
                        scale = FiveScaleKo.ALWAYS_NO,
                        source = AnswerSource.ENUM_SCHEMA_PRIMARY,
                        guardDegraded = false,
                    )
                coEvery { riddleService.answer("test-chat", "바나나인가요?") } returns answerResult

                val response = controller.answer("test-chat", RiddleAnswerRequest("바나나인가요?"), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.scale).isEqualTo("아니오")
            }

        @Test
        fun `정상 케이스 - MOSTLY_YES 응답`() =
            runBlocking {
                val answerResult =
                    AnswerResult(
                        scale = FiveScaleKo.MOSTLY_YES,
                        source = AnswerSource.ENUM_SCHEMA_PRIMARY,
                        guardDegraded = false,
                    )
                coEvery { riddleService.answer("test-chat", "과일인가요?") } returns answerResult

                val response = controller.answer("test-chat", RiddleAnswerRequest("과일인가요?"), request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.scale).isEqualTo("아마도 예")
            }
    }

    @Nested
    @DisplayName("POST /api/twentyq/riddle/reveal")
    inner class RevealTests {
        @Test
        fun `정상 케이스 - 정답 공개`() =
            runBlocking {
                coEvery { riddleService.reveal("test-chat") } returns "정답은 '사과'입니다!"

                val response = controller.reveal("test-chat", request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.solution).isEqualTo("정답은 '사과'입니다!")
            }

        @Test
        fun `헤더 없이 요청 - IP 기반 chatId 사용`() =
            runBlocking {
                coEvery { riddleService.reveal(any()) } returns "정답은 '포도'입니다!"

                val response = controller.reveal(null, request)

                assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
                assertThat(response.body?.solution).isEqualTo("정답은 '포도'입니다!")
            }
    }

    @Nested
    @DisplayName("GET /api/twentyq/riddle/status")
    inner class StatusTests {
        @Test
        fun `정상 케이스 - 게임 상태 조회`() {
            val status =
                RiddleStatusResponse(
                    questionCount = 5,
                    questions =
                        listOf(
                            QuestionHistory(1, "질문1", "예"),
                            QuestionHistory(2, "질문2", "아니오"),
                        ),
                    hints =
                        listOf(
                            HintHistory(1, "힌트1"),
                        ),
                    hintCount = 1,
                    maxHints = 3,
                    remainingHints = 2,
                    selectedCategory = null,
                )
            every { riddleService.getStatus("test-chat") } returns status

            val response = controller.status("test-chat", request)

            assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
            assertThat(response.body?.questionCount).isEqualTo(5)
            assertThat(response.body?.questions).hasSize(2)
            assertThat(response.body?.hints).hasSize(1)
            assertThat(response.body?.hintCount).isEqualTo(1)
            assertThat(response.body?.maxHints).isEqualTo(3)
        }

        @Test
        fun `카테고리 선택된 상태 조회`() {
            val status =
                RiddleStatusResponse(
                    questionCount = 0,
                    questions = emptyList(),
                    hints = emptyList(),
                    hintCount = 0,
                    maxHints = 3,
                    remainingHints = 3,
                    selectedCategory = "음식",
                )
            every { riddleService.getStatus("test-chat") } returns status

            val response = controller.status("test-chat", request)

            assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
            assertThat(response.body?.selectedCategory).isEqualTo("음식")
        }
    }
}
