# syntax=docker/dockerfile:1.7

ARG GO_VERSION=1.25.5
ARG ALPINE_VERSION=3.23

FROM golang:${GO_VERSION}-alpine${ALPINE_VERSION} AS builder

# 빌드 시 버전 주입 (docker-compose args 또는 --build-arg로 전달)
ARG VERSION=dev

WORKDIR /app

COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod --mount=type=cache,target=/root/.cache/go-build go mod download

COPY . .

RUN --mount=type=cache,target=/go/pkg/mod --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 GOEXPERIMENT=greenteagc \
    go build -tags go_json -trimpath -buildvcs=false -ldflags="-s -w -buildid= -X main.Version=${VERSION}" -o /dist/bin/twentyq ./cmd/twentyq && \
    go build -tags go_json -trimpath -buildvcs=false -ldflags="-s -w -buildid= -X main.Version=${VERSION}" -o /dist/bin/turtlesoup ./cmd/turtlesoup && \
    mkdir -p /dist/logs /dist/internal/twentyq /dist/internal/turtlesoup && \
    cp -r internal/twentyq/assets /dist/internal/twentyq/ && \
    cp -r internal/turtlesoup/assets /dist/internal/turtlesoup/

FROM alpine:${ALPINE_VERSION}

RUN apk add --no-cache ca-certificates tini tzdata && \
    cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime && \
    echo "Asia/Seoul" > /etc/timezone && \
    cp /usr/share/zoneinfo/Asia/Seoul /tmp/Seoul && \
    apk del --no-cache tzdata && \
    mkdir -p /usr/share/zoneinfo/Asia && \
    mv /tmp/Seoul /usr/share/zoneinfo/Asia/Seoul

RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR /app

COPY --from=builder --link --chown=appuser:appuser /dist ./

ENV GOGC=200 \
    GOMEMLIMIT=450MiB \
    GIN_MODE=release

EXPOSE 30081 30082

HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD wget -q --spider http://127.0.0.1:30081/health || wget -q --spider http://127.0.0.1:30082/health || exit 1

USER appuser

ENTRYPOINT ["/sbin/tini", "--"]
CMD ["./bin/twentyq"]